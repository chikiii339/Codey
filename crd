import os
import subprocess

username = input("Enter your username: ")
password = input("Enter a password: ")
print("Creating your user... Please wait.")

# Create new user and set password
os.system(f"useradd -m {username}")
os.system(f"adduser {username} sudo")
os.system(f"echo '{username}:{password}' | sudo chpasswd")
os.system("sed -i 's/\\/bin\\/sh/\\/bin\\/bash/g' /etc/passwd")

print(f"User `{username}` created successfully with password `{password}`")

# Chrome Remote Desktop setup inputs
CRP = input("Paste your Chrome Remote Desktop command: ")
Pin = input("Choose a PIN for your Chrome RDP (min 6 digits): ")

Autostart = True

class CRD:
    def __init__(self, user):
        os.system("apt update -y && apt upgrade -y")
        self.install_crd()
        self.install_xfce()
        self.install_chrome()
        self.finish(user)
        print("\n✅ RDP setup complete. Visit: https://remotedesktop.google.com/access")

    @staticmethod
    def install_crd():
        print("Installing Chrome Remote Desktop...")
        subprocess.run(["wget", "https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb"])
        subprocess.run(["dpkg", "-i", "chrome-remote-desktop_current_amd64.deb"])
        subprocess.run(["apt", "-f", "install", "-y"])

    @staticmethod
    def install_xfce():
        print("Installing XFCE desktop environment...")
        os.environ["DEBIAN_FRONTEND"] = "noninteractive"
        os.system("apt install -y xfce4 xfce4-terminal desktop-base xscreensaver")
        os.system("bash -c 'echo \"exec /etc/X11/Xsession /usr/bin/xfce4-session\" > /etc/chrome-remote-desktop-session'")
        os.system("systemctl disable lightdm.service")

    @staticmethod
    def install_chrome():
        print("Installing Google Chrome...")
        subprocess.run(["wget", "https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"])
        subprocess.run(["dpkg", "-i", "google-chrome-stable_current_amd64.deb"])
        subprocess.run(["apt", "-f", "install", "-y"])

    @staticmethod
    def finish(user):
        print("Finalizing setup...")
        if Autostart:
            os.makedirs(f"/home/{user}/.config/autostart", exist_ok=True)
            desktop_entry = f"""[Desktop Entry]
Type=Application
Name=Chrome Remote Desktop Access
Exec=sh -c "sensible-browser https://remotedesktop.google.com/access"
Icon=
Comment=Auto-launch Chrome RDP
X-GNOME-Autostart-enabled=true"""
            with open(f"/home/{user}/.config/autostart/rdp.desktop", "w") as f:
                f.write(desktop_entry)
            os.system(f"chmod +x /home/{user}/.config/autostart/rdp.desktop")
            os.system(f"chown -R {user}:{user} /home/{user}/.config")

        os.system(f"adduser {user} chrome-remote-desktop")
        os.system(f"su - {user} -c '{CRP} --pin={Pin}'")
        os.system("systemctl start chrome-remote-desktop")

try:
    if CRP.strip() == "":
        print("❌ Please provide a valid CRD command.")
    elif len(Pin) < 6:
        print("❌ PIN must be at least 6 digits.")
    else:
        CRD(username)
except Exception as e:
            print(f"⚠️ Error occurred: {e}")
